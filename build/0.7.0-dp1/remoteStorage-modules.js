/**
 * vCardJS - a vCard 4.0 implementation in JavaScript
 *
 * (c) 2012 - Niklas Cathor
 *
 * Latest source: https://github.com/nilclass/vcardjs
 **/

/*!
Math.uuid.js (v1.4)
http://www.broofa.com
mailto:robert@broofa.com

Copyright (c) 2010 Robert Kieffer
Dual licensed under the MIT and GPL licenses.
*/

(function(){function r(n,r,i){n=String(n),e[n]=i;var s=n.substring(0,n.lastIndexOf("/")+1);t[n]=[];for(var o=0;o<r.length;o++){r[o].substring(0,2)=="./"&&(r[o]=r[o].substring(2));if(r[o].substring(0,3)=="../"){r[o]=r[o].substring(3);var u=s.split("/");u.pop(),u.pop(),s=u.join("/"),s.length&&(s+="/")}t[n].push(s+r[o])}}function i(r){if(r=="require")return function(){};var s=t[r];for(var o=0;o<s.length;o++)n[s[o]]||(n[s[o]]=i(s[o]));var u=[];for(var o=0;o<s.length;o++)u.push(n[s[o]]);return e[r].apply({},u)}var e={},t={},n={};remoteStorage.defineModule("public",function(e){function t(){return e.getObject("publishedItems")}return{exports:{getPublicItems:t,getObject:e.getObject}}}),remoteStorage.defineModule("root",function(e,t){function n(n){e.on("change",function(e){console.log(e),n(e)}),t.on("change",function(e){console.log(e),n(e)})}function r(e){var n=t.getObject("publishedItems");e[0]=="/"&&(e=e.substr(1)),n?n.indexOf(e)==-1&&n.unshift(e):(n=[],n.push(e)),t.storeObject("array","publishedItems",n)}function i(e){var n=t.getObject("publishedItems");e[0]=="/"&&(e=e.substr(1)),n?$.inArray(e,n)!=1&&n.pop(e):n=[],t.storeObject("array","publishedItems",n)}function s(t){if(u(t))return"Object has already been made public";var n=e.getObject(t),i="/public"+t;return r(i),e.remove(t),e.storeObject(n["@type"],i,n),"Object "+t+" has been published to "+i}function o(t){if(!u(t))return"Object has already been made private";var n=e.getObject(t),r=t.substring(7,t.length);return i(t),e.remove(t),e.storeObject(n["@type"],r,n),"Object "+t+" has been archived to "+r}function u(e){return e.substring(0,8)=="/public/"?!0:!1}function a(n){return u(n)?t:e}function f(e,t,n){var r=a(e);return r.getObject(e,t,n)}function l(e,t,n){var r=a(t);r.storeObject(e,t,n)}function c(e){var t=a(e);t.remove(e)}function h(e,t,n){var r=a(e);return r.getListing(e,t,n)}return{exports:{getListing:h,getObject:f,setObject:l,removeObject:c,archiveObject:o,publishObject:s,setOnChange:n}}}),r("modules/root",function(){}),remoteStorage.defineModule("calendar",function(e){function t(t){var n=e.getListing(t+"/"),r=[];for(var i=0;i<n.length;i++){var s=e.getObject(t+"/"+n[i]);r.push({itemId:n[i],itemValue:s.text})}return r}function n(t,n,r){e.storeObject("event",n+"/"+t,{text:r})}function r(t,n){e.remove(n+"/"+t)}return{exports:{getEventsForDay:t,addEvent:n,removeEvent:r}}}),r("modules/calendar",function(){}),function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var r=e,i=[],s;n=n||r.length;if(t)for(s=0;s<t;s++)i[s]=r[0|Math.random()*n];else{var o;i[8]=i[13]=i[18]=i[23]="-",i[14]="4";for(s=0;s<36;s++)i[s]||(o=0|Math.random()*16,i[s]=r[s==19?o&3|8:o])}return i.join("")},Math.uuidFast=function(){var t=e,n=new Array(36),r=0,i;for(var s=0;s<36;s++)s==8||s==13||s==18||s==23?n[s]="-":s==14?n[s]="4":(r<=2&&(r=33554432+Math.random()*16777216|0),i=r&15,r>>=4,n[s]=t[s==19?i&3|8:i]);return n.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}}();var s;(function(){s=function(e){this.changed=!1;if(typeof e=="object")for(var t in e)this[t]=e[t],this.changed=!0},s.prototype={validate:function(){function t(t,n){e.push([t,n])}function r(t,n){for(var r in n){var i=n[r];typeof i!="object"?e.push([t+"-"+r,"not-an-object"]):i.type?i.value||e.push([t+"-"+r,"missing-value"]):e.push([t+"-"+r,"missing-type"])}}var e=[];this.fn||t("fn","required");for(var n in s.multivaluedKeys)this[n]&&!(this[n]instanceof Array)&&(this[n]=[this[n]]);return this.email&&r("email",this.email),this.tel&&r("email",this.tel),this.uid||this.addAttribute("uid",this.generateUID()),this.rev||this.addAttribute("rev",this.generateRev()),this.errors=e,!(e.length>0)},generateUID:function(){return"uuid:"+Math.uuid()},generateRev:function(){return(new Date).toISOString().replace(/[\.\:\-]/g,"")},setAttribute:function(e,t){this[e]=t,this.changed=!0},addAttribute:function(e,t){console.log("add attribute",e,t);if(!t)return;s.multivaluedKeys[e]?this[e]?(console.log("multivalued push"),this[e].push(t)):(console.log("multivalued set"),this.setAttribute(e,[t])):this.setAttribute(e,t)},toJSON:function(){return JSON.stringify(this.toJCard())},toJCard:function(){var e={};for(var t in s.allKeys){var n=s.allKeys[t];this[n]&&(e[n]=this[n])}return e},merge:function(e){function n(n){e[n]?e[n]==this[n]?t.setAttribute(this[n]):(t.addAttribute(this[n]),t.addAttribute(e[n])):t[n]=this[n]}if(typeof e.uid!="undefined"&&typeof this.uid!="undefined"&&e.uid!==this.uid)throw"Won't merge vcards without matching UIDs.";var t=new s;for(key in this)n(key);for(key in e)t[key]||n(key)}},s.enums={telType:["text","voice","fax","cell","video","pager","textphone"],relatedType:["contact","acquaintance","friend","met","co-worker","colleague","co-resident","neighbor","child","parent","sibling","spouse","kin","muse","crush","date","sweetheart","me","agent","emergency"],emailType:["work","home","internet"],langType:["work","home"]},s.allKeys=["fn","n","nickname","photo","bday","anniversary","gender","tel","email","impp","lang","tz","geo","title","role","logo","org","member","related","categories","note","prodid","rev","sound","uid"],s.multivaluedKeys={email:!0,tel:!0,geo:!0,title:!0,role:!0,logo:!0,org:!0,member:!0,related:!0,categories:!0,note:!0}})();var o;(function(){o={simpleKeys:["VERSION","FN","PHOTO","GEO","TITLE","ROLE","LOGO","MEMBER","NOTE","PRODID","SOUND","UID"],csvKeys:["NICKNAME","CATEGORIES"],dateAndOrTimeKeys:["BDAY","ANNIVERSARY","REV"],parse:function(e,t,n){var r=null;n||(n=this),this.lex(e,function(e,i,o){function u(t){r&&r.addAttribute(e.toLowerCase(),t)}if(e=="BEGIN")r=new s;else if(e=="END")r&&(t.apply(n,[r]),r=null);else if(this.simpleKeys.indexOf(e)!=-1)u(i);else if(this.csvKeys.indexOf(e)!=-1)u(i.split(","));else if(this.dateAndOrTimeKeys.indexOf(e)!=-1)o.VALUE=="text"?u(i):(!o.CALSCALE||o.CALSCALE=="gregorian")&&u(this.parseDateAndOrTime(i));else if(e=="N")u(this.parseName(i));else if(e=="GENDER")u(this.parseGender(i));else if(e=="TEL")u({type:o.TYPE||"voice",pref:o.PREF,value:i});else if(e=="EMAIL")u({type:o.TYPE,pref:o.PREF,value:i});else if(e=="IMPP")u({value:i});else if(e=="LANG")u({type:o.TYPE,pref:o.PREF,value:i});else if(e=="TZ")o.VALUE=="utc-offset"?u({"utc-offset":this.parseTimezone(i)}):u({name:i});else if(e=="ORG"){var a=i.split(";");u({"organization-name":a[0],"organization-unit":a[1]})}else e=="RELATED"?u({type:o.TYPE,pref:o.PREF,value:o.VALUE}):console.log("WARNING: unhandled key: ",e)})},nameParts:["family-name","given-name","additional-name","honorific-prefix","honorific-suffix"],parseName:function(e){var t=e.split(";"),n={};for(var r in t)t[r]&&(n[this.nameParts[r]]=t[r].split(","));return n},parseGender:function(e){var t={},n=e.split(";");switch(n[0]){case"M":t.sex="male";break;case"F":t.sex="female";break;case"O":t.sex="other"}return n[1]&&(t.identity=n[1]),t},dateRE:/^(\d{4})(\d{2})(\d{2})$/,dateReducedARE:/^(\d{4})\-(\d{2})$/,dateReducedBRE:/^(\d{4})$/,dateTruncatedMDRE:/^\-{2}(\d{2})(\d{2})$/,dateTruncatedDRE:/^\-{3}(\d{2})$/,timeRE:/^(\d{2})(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeReducedARE:/^(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeReducedBRE:/^(\d{2})([+\-]\d+|Z|)$/,timeTruncatedMSRE:/^\-{2}(\d{2})(\d{2})([+\-]\d+|Z|)$/,timeTruncatedSRE:/^\-{3}(\d{2})([+\-]\d+|Z|)$/,parseDate:function(e){var t,n,r,i;if(t=e.match(this.dateRE))n=t[1],r=t[2],i=t[3];else if(t=e.match(this.dateReducedARE))n=t[1],r=t[2];else if(t=e.match(this.dateReducedBRE))n=t[1];else if(t=e.match(this.dateTruncatedMDRE))r=t[1],i=t[2];else{if(!(t=e.match(this.dateTruncatedDRE)))return console.error("WARNING: failed to parse date: ",e),null;i=t[1]}var s=new Date(0);return typeof n!="undefined"&&s.setUTCFullYear(n),typeof r!="undefined"&&s.setUTCMonth(r-1),typeof i!="undefined"&&s.setUTCDate(i),s},parseTime:function(e){var t,n,r,i,s;if(t=e.match(this.timeRE))n=t[1],r=t[2],i=t[3],s=t[4];else if(t=e.match(this.timeReducedARE))n=t[1],r=t[2],s=t[3];else if(t=e.match(this.timeReducedBRE))n=t[1],s=t[2];else if(t=e.match(this.timeTruncatedMSRE))r=t[1],i=t[2],s=t[3];else{if(!(t=e.match(this.timeTruncatedSRE)))return console.error("WARNING: failed to parse time: ",e),null;i=t[1],s=t[2]}var o=new Date(0);return typeof n!="undefined"&&o.setUTCHours(n),typeof r!="undefined"&&o.setUTCMinutes(r),typeof i!="undefined"&&o.setUTCSeconds(i),s&&(o=this.applyTimezone(o,s)),o},addDates:function(e,t,n){typeof n=="undefined"&&(n=!0);if(!e)return t;if(!t)return e;var r=Number(e),i=Number(t),s=n?r+i:r-i;return new Date(s)},parseTimezone:function(e){var t;if(t=e.match(/^([+\-])(\d{2})(\d{2})?/)){var n=new Date(0);return n.setUTCHours(t[2]),n.setUTCMinutes(t[3]||0),Number(n)*(t[1]=="+"?1:-1)}return null},applyTimezone:function(e,t){var n=this.parseTimezone(t);return n?new Date(Number(e)+n):e},parseDateTime:function(e){var t=e.split("T"),n=this.parseDate(t[0]),r=this.parseTime(t[1]);return this.addDates(n,r)},parseDateAndOrTime:function(e){switch(e.indexOf("T")){case 0:return this.parseTime(e.slice(1));case-1:return this.parseDate(e);default:return this.parseDateTime(e)}},lineRE:/^([^\s].*)(?:\r?\n|$)/,foldedLineRE:/^\s(.+)(?:\r?\n|$)/,lex:function(e,t){var n,r=null,i=0;for(;;){(n=e.match(this.lineRE))?(r&&this.lexLine(r,t),r=n[1],i=n[0].length):(n=e.match(this.foldedLineRE))?r&&(r+=n[1],i=n[0].length):console.error("Unmatched line: "+r),e=e.slice(i);if(!e)break}r&&this.lexLine(r,t),r=null},lexLine:function(e,t){function u(){if(r){if(!o){console.error("Invalid attribute: ",n,"Line dropped.");return}i[o]=n}else r=n}var n="",r=null,i={},s=null,o=null;for(var a in e){var f=e[a];switch(f){case":":u(),s=e.slice(Number(a)+1),t.apply(this,[r,s,i]);return;case";":u(),n="";break;case"=":o=n,n="";break;default:n+=f}}}}})(),r("modules/deps/vcardjs-0.2.js",function(){}),remoteStorage.defineModule("contacts",function(e){function n(e,t){var n=Object.keys(t);for(var r=0;r<n.length;r++){var i=n[r];e[i]=t[i]}return e}function r(e,t){return t?function(){return e.apply(t,arguments)}:e}var t=!0;if(typeof s=="undefined")return console.error("remoteStorage.contacts requires vCardJS from https://github.com/nilclass/vcardjs"),{exports:{}};var i=t?r(console.log,console):function(){},o=function(){s.apply(this,arguments)};o.prototype=n({isNew:!0,save:function(){return this.validate(),this.errors&&this.errors.length>0?!1:(e.storeObject("vcard",this.uid,this.toJCard()),this.markSaved(),!0)},markSaved:function(){return this.isNew=!1,this.changed=!1,this}},s.prototype);var u={Contact:o,on:e.on,list:function(t,n){var r=e.getListing("");n||(n=0),t||(t=r.length-n);for(var i=0;i<t;i++)r[i+n]=this.get(r[i+n]);return r},get:function(t,n,i){if(!n)return this._load(e.getObject(t));e.getObject(t,function(e){r(n,i)(this._load(e))},this)},build:function(e){return this._wrap(e)},create:function(e){var t=this.build(e);return t.save(),t},filter:function(e,t){var n=this.list(),i=[],s;for(var o=0;o<n.length;o++)s=r(e,t)(n[o]),s&&i.push(s);return i},search:function(e){var t=Object.keys(e);return this.filter(function(n){for(var r=0;r<t.length;r++){var s=t[r],o=e[s];i("check ",s," == ",o," in ",n,"(",n[s],")");if(typeof o=="string"&&o.length===0)continue;if(o instanceof RegExp){if(!o.test(n[s]))return!1}else if(n[s]!==o)return!1}return i("success"),n},this)},_load:function(e){return this._wrap(e).markSaved()},_wrap:function(e){return e instanceof o?e:new o(e)}};return{exports:u}}),r("modules/contacts",function(){}),remoteStorage.defineModule("documents",function(e){function n(e,n){if(e=="error")for(var r=0;r<t.length;r++)t[r](n)}function r(){var e="",t,n;for(t=0;t<32;t++){n=Math.random()*16|0;if(t===8||t===12||t===16||t===20)e+="-";e+=(t===12?4:t===16?n&3|8:n).toString(16)}return e}function i(n){function i(){return e.getListing(n+"/")}function s(t){var r=e.getObject(n+"/"+t);return r?r.content:""}function o(e){return s(e).slice(0,50)}function u(t,r){r==""?e.remove(n+"/"+t):e.storeObject("text",n+"/"+t,{content:r})}function a(t){var i=r();return e.storeObject("text",n+"/"+i,{content:t}),i}function f(n,r){e.on(n,r),n=="error"&&t.push(r)}return e.sync(n+"/"),{getIds:i,getContent:s,getTitle:o,setContent:u,add:a,on:f}}var t=[];return{name:"documents",dataHints:{module:"documents can be text documents, or etherpad-lite documents or pdfs or whatever people consider a (text) document. But spreadsheets and diagrams probably not","objectType text":"a human-readable plain-text document in utf-8. No html or markdown etc, they should have their own object types","string text#content":"the content of the text document","directory documents/notes/":"used by litewrite for quick notes","item documents/notes/calendar":"used by docrastinate for the 'calendar' pane","item documents/notes/projects":"used by docrastinate for the 'projects' pane","item documents/notes/personal":"used by docrastinate for the 'personal' pane"},exports:{getPrivateList:i}}}),r("modules/documents",function(){}),remoteStorage.defineModule("money",function(e){function t(){var e="",t,n;for(t=0;t<32;t++){n=Math.random()*16|0;if(t===8||t===12||t===16||t===20)e+="-";e+=(t===12?4:t===16?n&3|8:n).toString(16)}return e}function n(n,r,i,s,o,u){var a=t();e.storeObject("IOU","IOUs/"+u+"/"+o+"/"+s+"/"+a,{tag:n,thing:r,amount:-i}),e.storeObject("IOU","IOUs/"+o+"/"+u+"/"+s+"/"+a,{tag:n,thing:r,amount:i})}function r(e,t,r,i,s,o){n(i,r,s,o,e,t)}function i(e,t,r,i,s){n(r,"transfer",i,s,e,t)}function s(e,t,n,r,i,s){for(var o in n){var u=n[o];remoteStorage.money.addIOU(t,s,u,"EUR",o,e);var a=u/r.length;for(var f=0;f<r.length;f++)remoteStorage.money.addIOU(t,s,a,"EUR",e,r[f])}}function o(t,n){var r=e.getListing("IOUs/"+t+"/"),i=0;for(var s=0;s<r.length;s++){var o=0,u=e.getListing("IOUs/"+t+"/"+r[s]+n+"/");for(var a=0;a<u.length;a++){var f=e.getObject("IOUs/"+t+"/"+r[s]+n+"/"+u[a]);o+=f.amount}i+=o}return i}function u(t){var n=e.getListing("IOUs/"),r={};for(var i=0;i<n.length;i++){var s=n[i].substring(0,n[i].length-1);r[s]=o(s,t)}return r}function a(t,n,r,i){var s={};s[i]=r,e.storeObject("balance",t+"/0/"+n+"/balance",s)}return{name:"money",dataVersion:"0.1",dataHints:{module:"Peer-to-peer bookkeeping based on IOUs (writing down who owes who how much)"},codeVersion:"0.1.0",exports:{reportTransfer:i,addIOU:n,addDeclaration:r,groupPayment:s,getBalances2:u,setBalance:a}}}),r("modules/money",function(){}),remoteStorage.defineModule("tasks",function(e,t){function r(e,t){if(e=="error")for(var r=0;r<n.length;r++)n[r](t)}function i(){var e="",t,n;for(t=0;t<32;t++){n=Math.random()*16|0;if(t===8||t===12||t===16||t===20)e+="-";e+=(t===12?4:t===16?n&3|8:n).toString(16)}return e}function s(t){function r(){return e.getListing(t+"/")}function s(n){return e.getObject(t+"/"+n)}function o(n,r){var i=e.getObject(t+"/"+n);i.title=r,e.storeObject("task",t+"/"+n,i)}function u(n){var r=i();return e.storeObject("task",t+"/"+r,{title:n,completed:!1}),r}function a(n,r){typeof r=="undefined"&&(r=!0);var i=e.getObject(t+"/"+n);i&&i.completed!=r&&(i.completed=r,e.storeObject("task",t+"/"+n,i))}function f(e){var t=s(e);return t&&t.completed}function l(){var e=r(),t={todoCompleted:0,totalTodo:e.length};for(var n=0;n<t.totalTodo;n++)f(e[n])&&(t.todoCompleted+=1);return t.todoLeft=t.totalTodo-t.todoCompleted,t}function c(n){e.remove(t+"/"+n)}function h(t,r){e.on(t,r),t=="error"&&n.push(r)}return e.sync(t+"/"),{getIds:r,get:s,set:o,add:u,remove:c,markCompleted:a,getStats:l,on:h}}var n=[];return{name:"tasks",dataHints:{module:"tasks are things that need doing; items on your todo list","objectType task":"something that needs doing, like cleaning the windows or fixing a specific bug in a program","string task#title":"describes what it is that needs doing","boolean task#completed":"whether the task has already been completed or not (yet)","directory tasks/todos/":"default private todo list","directory tasks/:year/":"tasks that need doing during year :year","directory public/tasks/:hash/":"tasks list shared to for instance a team"},exports:{getPrivateList:s}}}),r("modules/tasks",function(){}),r("remoteStorage-modules",["./modules/root","./modules/calendar","./modules/deps/vcardjs-0.2.js","./modules/contacts","./modules/documents","./modules/money","./modules/tasks"],function(){return{}})})()