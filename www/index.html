<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />

<title>Myfavouritesandwich - An Unhosted demo</title>
<link rel="stylesheet" href="css/uncompressed/reset.css" />
<link rel="stylesheet" href="css/uncompressed/text.css" />
<link rel="stylesheet" href="css/uncompressed/general.css" />
<link rel="stylesheet" href="css/uncompressed/layout.css" />

<script src="https://browserid.org/include.js" type="text/javascript"></script>
<script src="jquery-1.6.1.min.js"></script>
<script src="base64.js"></script>
<script src="davStorage.js"></script>
<script src="syncStorage.js"></script>
<script src="webfinger.js"></script>
<script src="config.js"></script>
<script>
$(document).ready(function() {
	if (window.location != config.appUrl) {
		window.location = config.appUrl;
	}
	addEventListener('storage', storage_event, false);
	show();
});

function val(v) {
  if (v === null) return "[null]";
  if (v === '') return "[the empty string]";
  if ('string' == typeof v) return '"'+ v +'"';
  if ('undefined' == typeof v) return '[undefined]';
  return '['+ typeof v + ': '+ v + ']';;
}

function log(msg) {
  var text = $('#log').val();
  $('#log').val(text + msg + "\n");
}

function storage_event(e) {
  log('Got '+ e.type +' event for '+ val(e.key) +' key; new value: '+ val(e.newValue) +'.');
	if(e.storageArea == syncStorage) {
		show();
	}
}

function storageEvent(e) {
}

function onsave() {
	var sandwich = {ingredients:
			[document.getElementById('firstIngredient').value,
			document.getElementById('secondIngredient').value]
		};
	syncStorage.setItem('favSandwich', JSON.stringify(sandwich));
	show();
}


//unfingered wallet contains: userAddress, dataScope, cryptoPwd
//  fingered wallet contains: userAddress, dataScope, cryptoPwd, davUrl, davToken
function login() {
	var walletStr = sessionStorage.getItem("wallet");
	if(walletStr) {
		var wallet = JSON.parse(walletStr);
		if(wallet.davToken) {
			window.syncStorage.pullFrom(wallet);
			window.syncStorage.syncKeys(["favSandwich"]);
		} else if(wallet.davUrl) {
			window.location = wallet.davUrl + "oauth2/auth"
				+ "?client_id="+encodeURIComponent(config.clientId)
				+ "&redirect_uri="+encodeURIComponent(config.callbackUrl)
				+ "&scope="+encodeURIComponent(wallet.dataScope)
				+ "&response_type=token"
				+ "&user_address="+encodeURIComponent(wallet.userAddress);
		} else {
			webfinger.getDavBaseUrl(wallet.userAddress, 0, 1, function(){
				debug = "offer hosted storage.";
			}, function(davUrl) {
				wallet.davUrl = dataFromWebfinger.davUrl;
				sessionStorage.setItem("wallet", JSON.stringify(wallet));
				login();
			});
		}
	} else {
		navigator.id.getVerifiedEmail(function(assertion) {
			if(assertion) {
				$.ajax({
					type: "POST",
					url: config.walletServiceUrl,
					data: {browserIdAssertion: assertion, dataScope: "sandwiches"},
					dataType: "text",
					success: function(walletStr) {
						sessionStorage.setItem("wallet", walletStr);
						login();
					}
				});
			}
		});
	}
}
function handleWalletStr(walletStr) {
			
}

  /////////////////////
 //  presentation:  //
/////////////////////

function show() {
	var sandwich = JSON.parse(syncStorage.getItem('favSandwich'));
	if(!sandwich) {
		sandwich = {ingredients:['', '']};
	}
	document.getElementById('showFirstIngredient').innerHTML = sandwich.ingredients[0];
	document.getElementById('showSecondIngredient').innerHTML = sandwich.ingredients[1];
	document.getElementById('firstIngredient').value = sandwich.ingredients[0];
	document.getElementById('secondIngredient').value = sandwich.ingredients[1];
}

</script>
</head>
<body>
<div class="preload"></div>
<div class="preload2"></div>
<div id="preheader"></div>
<div id="plateContainer">
	<figure id="plate"></figure>
</div>
<div id="mainWrap">
	<div id="unlockedView">
		<div id="preheader">
			<span>
				<input value="log in" type="submit" onclick="login();">
			</span>
		</div>
			
		<header class="data">
			<p>My favourite sandwich has <strong><span id="showFirstIngredient"></span></strong> and 
				<strong><span id="showSecondIngredient"></span></strong> on it</p>
			<input id="firstIngredient" placeholder='1st ingredient' type="text"/>
			<input id="secondIngredient" placeholder='2nd ingredient' type="text"/>	
			<input class="submitingredients" type="submit" value="Submit!" onclick="onsave();"/>
    <h1>Load this document into two or more tabs/windows</h1>

    Then click these buttons to see what happens in the other window:<br>

<input type="button" id="x5" value="Set x=5" />
<input type="button" id="x12" value="Set x=12" />
<input type="button" id="y17" value="Set y=17" />
<input type="button" id="y99" value="Set y=99" />
<input type="button" id="dex" value="Delete x" />
<input type="button" id="dey" value="Delete y" />
<input type="button" id="clr" value="Clear" />

<br>
When setting a key in this window, only other windows should see the event.<br>
Deleting a key should show that key get set to [null] in all other windows.<br>

Clearing all should show a [null] key get set to [null] in all other windows.

<textarea id="log" style="width:100%; height: 400px"></textarea>

		</header>
	</div>
	<div id="footerSpacer"></div>					
	<footer>
		<div class="wrapper">
		<div id="leftcolumn">
			<h3>So... what is this all about?</h3>
			<p>
				This is a fictional site that demonstrates the unhosted architecture, a tutorial, so you can take a look at the code to understand how to change this app into something more interesting. View the application source code <a href="https://github.com/unhosted/unhosted/blob/master/my-unhosted-website/www/index.html" target="_blank">here</a>.
			</p>
			<p>
				<strong>myfavouritesandwich.org is not a commercial website, nor is it affiliated with any trademark</strong>
			</p>
		</div>
		<figure id="island"></figure>
		<div id="rightcolumn">
			<h3>What is Unhosted?</h3>
			<p>
				<strong>Unhosted is a project for strengthening free software against hosted software. 
				</strong>
				An unhosted web app is only source code. Dynamic data is encrypted and decentralised, to per-user storage nodes. This benefits <strong>free software</strong>, as well as <strong>scalability</strong>, <strong>robustness</strong>, and <strong>online privacy</strong>.
			</p>
			<p>
				<strong>Check it out at <a href="http://www.unhosted.org">http://www.unhosted.org/</a></strong>
			</p>
		</div>
		<div class="clear">
		</div>				
	</footer>
</div>
</body>
</html>

